{% extends "base.html" %}

{% block title %}Dashboard - Auto-Board{% endblock %}

{% block content %}
    {% include 'common/nav.html' %}

    <div class="p-8 max-w-7xl mx-auto w-full">
        <!-- Header Section -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-[#1a1a2e] mb-2">대시보드</h1>
                    <p class="text-gray-600">환영합니다, <strong class="text-indigo-600">{{ user.username }}</strong>님!</p>
                </div>
                <a href="/boards/new/step1"
                    class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transform active:scale-95 transition-all">
                    + 새 기록물
                </a>
            </div>
        </div>

        <!-- Boards Grid -->
        {% if boards and boards|length > 0 %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for board in boards %}
            <div onclick="location.href='/boards/new/step1?board_id={{ board.id }}'"
                class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md hover:border-indigo-300 cursor-pointer transition-all transform hover:-translate-y-1">
                <div class="flex items-start justify-between mb-3">
                    <h3 class="text-lg font-bold text-[#1a1a2e] flex-1 pr-2">{{ board.name }}</h3>
                    <span class="text-xs font-semibold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">
                        ID: {{ board.id }}
                    </span>
                </div>

                {% if board.note %}
                <p class="text-gray-600 text-sm mb-4 line-clamp-2">{{ board.note }}</p>
                {% else %}
                <p class="text-gray-400 text-sm mb-4 italic">설명이 없습니다.</p>
                {% endif %}

                <div class="border-t border-gray-100 pt-3 mt-4">
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-gray-500">
                            생성: {{ board.created_at[:10] if board.created_at else '-' }}
                        </p>
                        <div class="flex gap-2">
                            <button type="button" onclick="event.stopPropagation(); location.href='/boards/new/step1?board_id={{ board.id }}'"
                                class="p-1.5 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded transition"
                                title="수정">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button type="button" class="delete-board-btn p-1.5 text-red-600 hover:text-red-700 hover:bg-red-50 rounded transition"
                                data-board-id="{{ board.id }}"
                                data-board-name="{{ board.name }}"
                                title="삭제">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-xl p-8 border border-gray-200 text-center">
            <div class="text-gray-400 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m0 0h6"></path>
                </svg>
            </div>
            <p class="text-gray-600 mb-4">아직 생성된 기록물이 없습니다.</p>
            <a href="/boards/new/step1"
                class="inline-block px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold transition-colors">
                첫 기록물 만들기
            </a>
        </div>
        {% endif %}
    </div>

    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>

    <script>
        // 1. 보드 삭제 버튼 이벤트 핸들러
        document.querySelectorAll('.delete-board-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();

                const boardId = btn.getAttribute('data-board-id');
                const boardName = btn.getAttribute('data-board-name');

                console.log(`[DELETE] 게시판 삭제 요청: board_id=${boardId}, name=${boardName}`);

                // 2. API 호출: 보드 정보 및 레코드 수 조회
                try {
                    const response = await fetch(`/boards/${boardId}/delete-info`);
                    if (!response.ok) {
                        throw new Error(`API 응답 오류: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log(`[DELETE] 조회 결과:`, data);

                    const recordCount = data.record_count || 0;
                    const tableExists = data.table_exists || false;

                    // 3. 경우에 따라 처리
                    if (!tableExists) {
                        // 케이스 1: 테이블이 없음 → 바로 삭제
                        console.log(`[DELETE] 테이블 없음 - 즉시 삭제 진행`);
                        if (confirm(`"${boardName}" 게시판을 삭제하시겠습니까?`)) {
                            await boardDashboard.performDelete(boardId);
                        }
                    } else if (recordCount === 0) {
                        // 케이스 2: 테이블은 있지만 레코드 없음 → 간단히 확인
                        console.log(`[DELETE] 빈 테이블 - 확인 대화창 표시`);
                        if (confirm(`"${boardName}" 게시판을 삭제하시겠습니까?\n(레코드: ${recordCount}개)`)) {
                            await boardDashboard.performDelete(boardId);
                        }
                    } else {
                        // 케이스 3: 레코드 있음 → 삭제 확인 페이지로 이동
                        console.log(`[DELETE] 레코드 있음 - 삭제 확인 페이지로 이동 (recordCount=${recordCount})`);
                        window.location.href = `/boards/${boardId}/delete-confirm`;
                    }
                } catch (error) {
                    console.error(`[DELETE] 오류 발생:`, error);
                    alert('게시판 정보를 조회할 수 없습니다.');
                }
            });
        });

        // 4. 보드 삭제 객체
        const boardDashboard = {
            // 5. 실제 삭제 수행
            performDelete: async (boardId) => {
                console.log(`[DELETE] 실제 삭제 수행: board_id=${boardId}`);
                try {
                    const response = await fetch(`/boards/${boardId}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error(`DELETE 응답 오류: ${response.status}`);
                    }

                    console.log(`[DELETE] 삭제 완료 - 대시보드로 리다이렉트`);
                    alert('게시판이 삭제되었습니다.');
                    window.location.href = '/';
                } catch (error) {
                    console.error(`[DELETE] 삭제 중 오류:`, error);
                    alert('게시판 삭제 중 오류가 발생했습니다.');
                }
            }
        };
    </script>
{% endblock %}
