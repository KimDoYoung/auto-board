{% extends "base.html" %}

{% block title %}Step 4: ìƒì„¸ë³´ê¸° ì„¤ì • - Auto-Board{% endblock %}

{% block content %}
{% include 'common/nav.html' %}

<div class="p-8 max-w-6xl mx-auto w-full">
    <div class="space-y-8">
        <!-- Progress Indicator -->
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">ë‹¨ê³„ 4/4: ìƒì„¸ë³´ê¸° ì„¤ì •</span>
                    <span class="text-sm text-gray-500">100%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full w-full bg-indigo-500 rounded-full transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <!-- Board Info -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-6">
            <p class="text-sm text-indigo-700">
                <span class="font-semibold">{{ board.name }}</span> (ID: {{ board.id }})
            </p>
        </div>

        <!-- Main Configuration -->
        <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
            <h2 class="text-2xl font-bold text-[#1a1a2e] mb-6 border-b pb-4">ìƒì„¸ë³´ê¸°(View) ì„¤ì •</h2>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 text-sm text-blue-700">
                <p class="font-semibold mb-1">ğŸ’¡ íŒ:</p>
                <p>ê¸°ë¡ì„ ìƒì„¸ë³´ê¸°í•  ë•Œ ê° í•„ë“œë¥¼ ì–´ë–»ê²Œ í‘œì‹œí• ì§€ ì„¤ì •í•©ë‹ˆë‹¤. í•„ë“œì˜ ìˆœì„œ, ê·¸ë£¹í•‘, ìŠ¤íƒ€ì¼, í¬ë§·ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div id="fieldsContainer" class="space-y-6 mb-8">
                <!-- Fields will be dynamically generated here -->
            </div>

            <!-- Add Section Button -->
            <button onclick="viewStep4.addSection()"
                class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-medium text-sm transition-colors flex items-center gap-2 mb-8">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                ì„¹ì…˜ ì¶”ê°€
            </button>

            <!-- Field Type Reference -->
            <div class="bg-gray-50 p-4 rounded-lg text-sm text-gray-600">
                <p class="font-semibold mb-2">í‘œì‹œ íƒ€ì…:</p>
                <ul class="grid grid-cols-2 gap-2 text-xs">
                    <li><span class="font-mono bg-white px-2 py-1 rounded">text</span> - ì¼ë°˜ í…ìŠ¤íŠ¸</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">date</span> - ë‚ ì§œ (í¬ë§· ê°€ëŠ¥)</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">datetime</span> - ë‚ ì§œ+ì‹œê°„</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">stars</span> - ë³„ì  í‘œì‹œ</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">currency</span> - í†µí™” í‘œì‹œ</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">boolean</span> - ì°¸/ê±°ì§“</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">badge</span> - ë°°ì§€ (ìƒ‰ìƒ ë§µ)</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">html</span> - HTML ì½˜í…ì¸ </li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">list</span> - ëª©ë¡/ë°°ì§€ ëª©ë¡</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">file_link</span> - íŒŒì¼ ë§í¬</li>
                </ul>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
            <h3 class="text-xl font-bold text-[#1a1a2e] mb-4 border-b pb-3">JSON ë¯¸ë¦¬ë³´ê¸°</h3>
            <pre class="bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto text-xs font-mono" id="jsonPreview">
{
  "display_fields": []
}</pre>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between gap-4">
            <a href="/boards/new/step3/{{ board.id }}"
                class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition-colors">
                ì´ì „ ë‹¨ê³„
            </a>
            <button onclick="viewStep4.submit()"
                class="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transform active:scale-95 transition-all">
                ë§ˆë¬´ë¦¬ (ì™„ë£Œ)
            </button>
        </div>
    </div>
</div>

<style>
.field-card {
    @apply bg-white p-4 rounded-lg border border-gray-200 space-y-3;
}
.field-card.section-header {
    @apply bg-gray-50 border-gray-300;
}
</style>

<script>
// Variables from Jinja2 template
const columnsData = JSON.parse('{{ columns|tojson|safe }}');

const viewStep4 = {
    sectionCount: 0,
    fieldCount: {},
    columns: columnsData,

    init() {
        // Initialize with default section
        this.addSection();
        this.populateFieldsFromColumns();
        this.updateJsonPreview();
    },

    populateFieldsFromColumns() {
        if (this.columns && this.columns.fields && this.columns.fields.length > 0) {
            const fieldsContainer = document.querySelector('[data-section-fields="1"]');
            this.columns.fields.forEach((col, idx) => {
                this.addField(1);
                const fieldEl = fieldsContainer.querySelectorAll('.field-card:not(.section-header)')[idx];
                if (fieldEl) {
                    fieldEl.querySelector('.field-name').value = col.name;
                    fieldEl.querySelector('.field-label').value = col.label || col.name;
                    // ë°ì´í„° íƒ€ì…ì— ë”°ë¼ ê¸°ë³¸ display_type ì„¤ì •
                    const displayType = this.getDefaultDisplayType(col.data_type);
                    fieldEl.querySelector('.field-display-type').value = displayType;
                    fieldEl.querySelector('.field-display-type').dispatchEvent(new Event('change'));
                }
            });
        }
    },

    getDefaultDisplayType(dataType) {
        const mapping = {
            'ymd': 'date',
            'datetime': 'datetime',
            'integer': 'text',
            'float': 'currency',
            'boolean': 'boolean',
            'text': 'html',
            'string': 'text'
        };
        return mapping[dataType] || 'text';
    },

    addSection() {
        this.sectionCount++;
        const container = document.getElementById('fieldsContainer');

        const section = document.createElement('div');
        section.className = 'bg-gray-50 rounded-lg p-6 space-y-4 border border-gray-200';
        section.dataset.sectionIndex = this.sectionCount;

        section.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <div class="flex-1">
                    <label class="block text-gray-700 font-medium text-sm mb-2">ì„¹ì…˜ ì œëª© (ì„ íƒ)</label>
                    <input type="text" class="section-title w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        placeholder="ì˜ˆ: ê¸°ë³¸ ì •ë³´, ìƒì„¸ ë‚´ìš©, ë©”íƒ€ì •ë³´">
                </div>
                <button onclick="viewStep4.removeSection(${this.sectionCount})" class="text-red-600 hover:text-red-700 font-semibold text-sm mt-6">
                    ì„¹ì…˜ ì‚­ì œ
                </button>
            </div>

            <div class="space-y-3" data-section-fields="${this.sectionCount}">
                <!-- Fields will be added here -->
            </div>

            <button onclick="viewStep4.addField(${this.sectionCount})"
                class="text-indigo-600 hover:text-indigo-700 font-medium text-sm flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                í•„ë“œ ì¶”ê°€
            </button>
        `;

        container.appendChild(section);
        this.fieldCount[this.sectionCount] = 0;
    },

    addField(sectionIndex) {
        this.fieldCount[sectionIndex]++;
        const fieldsContainer = document.querySelector(`[data-section-fields="${sectionIndex}"]`);

        const field = document.createElement('div');
        field.className = 'field-card';
        field.dataset.fieldIndex = this.fieldCount[sectionIndex];
        field.dataset.sectionIndex = sectionIndex;

        field.innerHTML = `
            <div class="grid grid-cols-4 gap-3">
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">í•„ë“œëª…</label>
                    <select class="field-name w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        ${this.columns.map(col => `<option value="${col.name}">${col.label || col.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">ë¼ë²¨</label>
                    <input type="text" class="field-label w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        placeholder="í‘œì‹œí•  ë¼ë²¨">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">í‘œì‹œ íƒ€ì…</label>
                    <select class="field-display-type w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        onchange="viewStep4.updateDisplayTypeOptions(this)">
                        <option value="text">text</option>
                        <option value="date">date</option>
                        <option value="datetime">datetime</option>
                        <option value="stars">stars</option>
                        <option value="currency">currency</option>
                        <option value="boolean">boolean</option>
                        <option value="badge">badge</option>
                        <option value="html">html</option>
                        <option value="list">list</option>
                        <option value="file_link">file_link</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">ë„ˆë¹„</label>
                    <input type="text" class="field-width w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        placeholder="30%, auto, ë“±">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">ë¼ì¸ ê·¸ë£¹ (ê°™ì€ ì¤„ í‘œì‹œ)</label>
                    <input type="text" class="field-inline-group w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        placeholder="ì˜ˆ: header, meta, footer">
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-full-width w-4 h-4 text-indigo-600 rounded">
                        <span class="text-gray-700 text-sm">ì „ì²´ ë„ˆë¹„</span>
                    </label>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-hide-label w-4 h-4 text-indigo-600 rounded">
                        <span class="text-gray-700 text-sm">ë¼ë²¨ ìˆ¨ê¸°ê¸°</span>
                    </label>
                </div>
            </div>

            <div>
                <label class="block text-gray-700 font-medium text-xs mb-1">ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤</label>
                <select class="field-style-class w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                    <option value="">ì„ íƒ ì•ˆ í•¨</option>
                    <option value="field-title">field-title (í° ì œëª©)</option>
                    <option value="field-subtitle">field-subtitle (ì¤‘ê°„ ì œëª©)</option>
                    <option value="field-heading">field-heading (ì†Œì œëª©)</option>
                    <option value="field-normal">field-normal (ì¼ë°˜ í…ìŠ¤íŠ¸)</option>
                    <option value="field-small">field-small (ì‘ì€ í…ìŠ¤íŠ¸)</option>
                    <option value="field-highlight">field-highlight (ê°•ì¡°)</option>
                    <option value="field-important">field-important (ì¤‘ìš”)</option>
                    <option value="field-info">field-info (ì •ë³´)</option>
                </select>
            </div>

            <div id="displayTypeOptions_${sectionIndex}_${this.fieldCount[sectionIndex]}" class="space-y-3">
                <!-- Display type specific options will be added here -->
            </div>

            <div>
                <button onclick="viewStep4.removeField(this)" class="text-red-600 hover:text-red-700 font-medium text-xs">
                    í•„ë“œ ì‚­ì œ
                </button>
            </div>
        `;

        fieldsContainer.appendChild(field);

        // Update preview on field change
        field.addEventListener('change', () => this.updateJsonPreview());
        field.addEventListener('input', () => this.updateJsonPreview());
    },

    updateDisplayTypeOptions(selectElement) {
        const displayType = selectElement.value;
        const fieldCard = selectElement.closest('.field-card');
        const sectionIndex = fieldCard.dataset.sectionIndex;
        const fieldIndex = fieldCard.dataset.fieldIndex;
        const optionsContainer = document.getElementById(`displayTypeOptions_${sectionIndex}_${fieldIndex}`);

        if (!optionsContainer) return;

        optionsContainer.innerHTML = '';

        if (displayType === 'date') {
            optionsContainer.innerHTML = `
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">ë‚ ì§œ í¬ë§·</label>
                    <input type="text" class="field-format w-full px-3 py-2 border border-gray-300 rounded text-sm"
                        placeholder="ì˜ˆ: YYYYë…„ MMì›” DDì¼" value="YYYY-MM-DD">
                </div>
            `;
        } else if (displayType === 'datetime') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ë‚ ì§œì‹œê°„ í¬ë§·</label>
                        <input type="text" class="field-format w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="ì˜ˆ: YYYY-MM-DD HH:mm" value="YYYY-MM-DD HH:mm">
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer mt-6">
                            <input type="checkbox" class="field-relative w-4 h-4 text-indigo-600 rounded">
                            <span class="text-gray-700 text-sm">ìƒëŒ€ ì‹œê°„ (2ì‹œê°„ ì „)</span>
                        </label>
                    </div>
                </div>
            `;
        } else if (displayType === 'stars') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ìµœëŒ€ ë³„ì </label>
                        <input type="number" class="field-max-stars w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="10" value="10" min="1" max="10">
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer mt-6">
                            <input type="checkbox" class="field-show-number w-4 h-4 text-indigo-600 rounded" checked>
                            <span class="text-gray-700 text-sm">ìˆ«ì í‘œì‹œ</span>
                        </label>
                    </div>
                </div>
            `;
        } else if (displayType === 'currency') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">í†µí™” ì½”ë“œ</label>
                        <input type="text" class="field-currency-code w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="KRW" value="KRW">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ì†Œìˆ˜ì </label>
                        <input type="number" class="field-decimal-places w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="0" value="0" min="0" max="3">
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer mt-6">
                            <input type="checkbox" class="field-thousands-separator w-4 h-4 text-indigo-600 rounded" checked>
                            <span class="text-gray-700 text-sm">ì²œë‹¨ìœ„ í‘œì‹œ</span>
                        </label>
                    </div>
                </div>
            `;
        } else if (displayType === 'boolean') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ì°¸ í…ìŠ¤íŠ¸</label>
                        <input type="text" class="field-true-text w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="ê³µê°œ" value="ê³µê°œ">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ê±°ì§“ í…ìŠ¤íŠ¸</label>
                        <input type="text" class="field-false-text w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="ë¹„ê³µê°œ" value="ë¹„ê³µê°œ">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ì°¸ ìƒ‰ìƒ</label>
                        <input type="text" class="field-true-class w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="text-green-600" value="text-green-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ê±°ì§“ ìƒ‰ìƒ</label>
                        <input type="text" class="field-false-class w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="text-gray-600" value="text-gray-600">
                    </div>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-show-icon w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-gray-700 text-sm">ì•„ì´ì½˜ í‘œì‹œ</span>
                    </label>
                </div>
            `;
        } else if (displayType === 'badge') {
            optionsContainer.innerHTML = `
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">ìƒ‰ìƒ ë§µ (JSON í˜•ì‹)</label>
                    <textarea class="field-badge-color-map w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono h-24"
                        placeholder='{"work": "blue", "personal": "green"}'></textarea>
                </div>
            `;
        } else if (displayType === 'html') {
            optionsContainer.innerHTML = `
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-sanitize w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-gray-700 text-sm">ìœ„í—˜í•œ ì½˜í…ì¸  ì œê±°</span>
                    </label>
                </div>
            `;
        } else if (displayType === 'list') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">í‘œì‹œ ë°©ì‹</label>
                        <select class="field-display-as w-full px-3 py-2 border border-gray-300 rounded text-sm">
                            <option value="badges">ë°°ì§€</option>
                            <option value="comma">ì‰¼í‘œ êµ¬ë¶„</option>
                            <option value="bullet">ê¸€ë¨¸ë¦¬</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">êµ¬ë¶„ì</label>
                        <input type="text" class="field-separator w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder=" " value=" ">
                    </div>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-hide-if-empty w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-gray-700 text-sm">ë¹„ì–´ìˆìœ¼ë©´ ìˆ¨ê¸°ê¸°</span>
                    </label>
                </div>
            `;
        } else if (displayType === 'file_link') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="field-show-size w-4 h-4 text-indigo-600 rounded" checked>
                            <span class="text-gray-700 text-sm">íŒŒì¼ í¬ê¸° í‘œì‹œ</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="field-show-icon w-4 h-4 text-indigo-600 rounded" checked>
                            <span class="text-gray-700 text-sm">ì•„ì´ì½˜ í‘œì‹œ</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-download w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-gray-700 text-sm">ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥</span>
                    </label>
                </div>
            `;
        }

        // Re-attach change listeners
        optionsContainer.addEventListener('change', () => this.updateJsonPreview());
        optionsContainer.addEventListener('input', () => this.updateJsonPreview());
    },

    removeField(button) {
        button.closest('.field-card').remove();
        this.updateJsonPreview();
    },

    removeSection(sectionIndex) {
        document.querySelector(`[data-section-index="${sectionIndex}"]`).remove();
        this.updateJsonPreview();
    },

    updateJsonPreview() {
        const displayFields = [];

        document.querySelectorAll('[data-section-index]').forEach(sectionEl => {
            const sectionIndex = sectionEl.dataset.sectionIndex;
            const sectionTitle = sectionEl.querySelector('.section-title').value.trim() || null;

            sectionEl.querySelectorAll('.field-card:not(.section-header)').forEach(fieldEl => {
                const fieldName = fieldEl.querySelector('.field-name').value.trim();
                const fieldLabel = fieldEl.querySelector('.field-label').value.trim();
                const displayType = fieldEl.querySelector('.field-display-type').value;
                const width = fieldEl.querySelector('.field-width').value.trim() || null;
                const inlineGroup = fieldEl.querySelector('.field-inline-group').value.trim() || null;
                const fullWidth = fieldEl.querySelector('.field-full-width').checked;
                const hideLabel = fieldEl.querySelector('.field-hide-label').checked;
                const styleClass = fieldEl.querySelector('.field-style-class').value || null;
                const order = displayFields.length + 1;

                if (!fieldName) return;

                const field = {
                    name: fieldName,
                    label: fieldLabel || fieldName,
                    display_type: displayType,
                    order: order,
                    ...(width && { width }),
                    ...(inlineGroup && { inline_group: inlineGroup }),
                    ...(fullWidth && { full_width: true }),
                    ...(hideLabel && { hide_label: true }),
                    ...(styleClass && { style_class: styleClass }),
                    ...(sectionTitle && { section: `section_${sectionIndex}`, section_title: sectionTitle })
                };

                // Add display type specific options
                if (displayType === 'date') {
                    const format = fieldEl.querySelector('.field-format')?.value.trim();
                    if (format) field.format = format;
                } else if (displayType === 'datetime') {
                    const format = fieldEl.querySelector('.field-format')?.value.trim();
                    if (format) field.format = format;
                    const relative = fieldEl.querySelector('.field-relative')?.checked;
                    if (relative) field.relative = true;
                } else if (displayType === 'stars') {
                    const maxStars = fieldEl.querySelector('.field-max-stars')?.value;
                    if (maxStars) field.max_stars = parseInt(maxStars);
                    const showNumber = fieldEl.querySelector('.field-show-number')?.checked;
                    if (showNumber) field.show_number = true;
                } else if (displayType === 'currency') {
                    const currencyCode = fieldEl.querySelector('.field-currency-code')?.value.trim();
                    if (currencyCode) field.currency_code = currencyCode;
                    const decimalPlaces = fieldEl.querySelector('.field-decimal-places')?.value;
                    if (decimalPlaces !== undefined) field.decimal_places = parseInt(decimalPlaces);
                    const separator = fieldEl.querySelector('.field-thousands-separator')?.checked;
                    if (separator) field.thousands_separator = true;
                } else if (displayType === 'boolean') {
                    const trueText = fieldEl.querySelector('.field-true-text')?.value.trim();
                    if (trueText) field.true_text = trueText;
                    const falseText = fieldEl.querySelector('.field-false-text')?.value.trim();
                    if (falseText) field.false_text = falseText;
                    const trueClass = fieldEl.querySelector('.field-true-class')?.value.trim();
                    if (trueClass) field.true_class = trueClass;
                    const falseClass = fieldEl.querySelector('.field-false-class')?.value.trim();
                    if (falseClass) field.false_class = falseClass;
                    const showIcon = fieldEl.querySelector('.field-show-icon')?.checked;
                    if (showIcon) field.show_icon = true;
                } else if (displayType === 'badge') {
                    const colorMap = fieldEl.querySelector('.field-badge-color-map')?.value.trim();
                    if (colorMap) {
                        try {
                            field.badge_color_map = JSON.parse(colorMap);
                        } catch (e) {
                            // Invalid JSON, skip
                        }
                    }
                } else if (displayType === 'html') {
                    const sanitize = fieldEl.querySelector('.field-sanitize')?.checked;
                    if (sanitize) field.sanitize = true;
                } else if (displayType === 'list') {
                    const displayAs = fieldEl.querySelector('.field-display-as')?.value;
                    if (displayAs) field.display_as = displayAs;
                    const separator = fieldEl.querySelector('.field-separator')?.value;
                    if (separator) field.separator = separator;
                    const hideIfEmpty = fieldEl.querySelector('.field-hide-if-empty')?.checked;
                    if (hideIfEmpty) field.hide_if_empty = true;
                } else if (displayType === 'file_link') {
                    const showSize = fieldEl.querySelector('.field-show-size')?.checked;
                    if (showSize) field.show_size = true;
                    const showIcon = fieldEl.querySelector('.field-show-icon')?.checked;
                    if (showIcon) field.show_icon = true;
                    const download = fieldEl.querySelector('.field-download')?.checked;
                    if (download) field.download = true;
                }

                displayFields.push(field);
            });
        });

        const jsonData = { display_fields: displayFields };
        document.getElementById('jsonPreview').textContent = JSON.stringify(jsonData, null, 2);
    },

    getFormData() {
        const displayFields = [];

        document.querySelectorAll('[data-section-index]').forEach(sectionEl => {
            const sectionIndex = sectionEl.dataset.sectionIndex;
            const sectionTitle = sectionEl.querySelector('.section-title').value.trim() || null;

            sectionEl.querySelectorAll('.field-card:not(.section-header)').forEach(fieldEl => {
                const fieldName = fieldEl.querySelector('.field-name').value.trim();
                if (!fieldName) return;

                const fieldLabel = fieldEl.querySelector('.field-label').value.trim();
                const displayType = fieldEl.querySelector('.field-display-type').value;
                const width = fieldEl.querySelector('.field-width').value.trim() || null;
                const inlineGroup = fieldEl.querySelector('.field-inline-group').value.trim() || null;
                const fullWidth = fieldEl.querySelector('.field-full-width').checked;
                const hideLabel = fieldEl.querySelector('.field-hide-label').checked;
                const styleClass = fieldEl.querySelector('.field-style-class').value || null;
                const order = displayFields.length + 1;

                const field = {
                    name: fieldName,
                    label: fieldLabel || fieldName,
                    display_type: displayType,
                    order: order,
                    ...(width && { width }),
                    ...(inlineGroup && { inline_group: inlineGroup }),
                    ...(fullWidth && { full_width: true }),
                    ...(hideLabel && { hide_label: true }),
                    ...(styleClass && { style_class: styleClass }),
                    ...(sectionTitle && { section: `section_${sectionIndex}`, section_title: sectionTitle })
                };

                // Add display type specific options
                if (displayType === 'date') {
                    const format = fieldEl.querySelector('.field-format')?.value.trim();
                    if (format) field.format = format;
                } else if (displayType === 'datetime') {
                    const format = fieldEl.querySelector('.field-format')?.value.trim();
                    if (format) field.format = format;
                    const relative = fieldEl.querySelector('.field-relative')?.checked;
                    if (relative) field.relative = true;
                } else if (displayType === 'stars') {
                    const maxStars = fieldEl.querySelector('.field-max-stars')?.value;
                    if (maxStars) field.max_stars = parseInt(maxStars);
                    const showNumber = fieldEl.querySelector('.field-show-number')?.checked;
                    if (showNumber) field.show_number = true;
                } else if (displayType === 'currency') {
                    const currencyCode = fieldEl.querySelector('.field-currency-code')?.value.trim();
                    if (currencyCode) field.currency_code = currencyCode;
                    const decimalPlaces = fieldEl.querySelector('.field-decimal-places')?.value;
                    if (decimalPlaces !== undefined) field.decimal_places = parseInt(decimalPlaces);
                    const separator = fieldEl.querySelector('.field-thousands-separator')?.checked;
                    if (separator) field.thousands_separator = true;
                } else if (displayType === 'boolean') {
                    const trueText = fieldEl.querySelector('.field-true-text')?.value.trim();
                    if (trueText) field.true_text = trueText;
                    const falseText = fieldEl.querySelector('.field-false-text')?.value.trim();
                    if (falseText) field.false_text = falseText;
                    const trueClass = fieldEl.querySelector('.field-true-class')?.value.trim();
                    if (trueClass) field.true_class = trueClass;
                    const falseClass = fieldEl.querySelector('.field-false-class')?.value.trim();
                    if (falseClass) field.false_class = falseClass;
                    const showIcon = fieldEl.querySelector('.field-show-icon')?.checked;
                    if (showIcon) field.show_icon = true;
                } else if (displayType === 'badge') {
                    const colorMap = fieldEl.querySelector('.field-badge-color-map')?.value.trim();
                    if (colorMap) {
                        try {
                            field.badge_color_map = JSON.parse(colorMap);
                        } catch (e) {
                            // Invalid JSON, skip
                        }
                    }
                } else if (displayType === 'html') {
                    const sanitize = fieldEl.querySelector('.field-sanitize')?.checked;
                    if (sanitize) field.sanitize = true;
                } else if (displayType === 'list') {
                    const displayAs = fieldEl.querySelector('.field-display-as')?.value;
                    if (displayAs) field.display_as = displayAs;
                    const separator = fieldEl.querySelector('.field-separator')?.value;
                    if (separator) field.separator = separator;
                    const hideIfEmpty = fieldEl.querySelector('.field-hide-if-empty')?.checked;
                    if (hideIfEmpty) field.hide_if_empty = true;
                } else if (displayType === 'file_link') {
                    const showSize = fieldEl.querySelector('.field-show-size')?.checked;
                    if (showSize) field.show_size = true;
                    const showIcon = fieldEl.querySelector('.field-show-icon')?.checked;
                    if (showIcon) field.show_icon = true;
                    const download = fieldEl.querySelector('.field-download')?.checked;
                    if (download) field.download = true;
                }

                displayFields.push(field);
            });
        });

        return {
            view: {
                display_fields: displayFields
            }
        };
    },

    async submit() {
        try {
            const formData = this.getFormData();

            const response = await fetch('/boards/new/step4/{{ board.id }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (!response.ok) {
                alert('ì˜¤ë¥˜: ' + data.detail);
                return;
            }

            window.location.href = data.redirect;
        } catch (error) {
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    viewStep4.init();
});
</script>
{% endblock %}
