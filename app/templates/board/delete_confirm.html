{% extends "base.html" %}

{% block title %}게시판 삭제 확인 - Auto-Board{% endblock %}

{% block content %}
    {% include 'common/nav.html' %}

    <div class="p-8 max-w-2xl mx-auto w-full">
        <!-- 경고 헤더 -->
        <div class="mb-8 bg-red-50 border-l-4 border-red-500 p-6 rounded-r-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-8 w-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4v2m0 4v2M7.458 5.5H5.25A2.25 2.25 0 003 7.75v11.5A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V7.75a2.25 2.25 0 00-2.25-2.25H16.542m-13.5 0V4.75C3 3.784 3.784 3 4.75 3h14.5c.966 0 1.75.784 1.75 1.75v1.75m0 5.5.75.75m0 2.5l.75.75"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <h2 class="text-lg font-bold text-red-700 mb-2">게시판 삭제 경고</h2>
                    <p class="text-red-600 text-sm">
                        이 작업은 되돌릴 수 없습니다. 게시판 "<strong>{{ board.name }}</strong>"에 포함된 모든 데이터가 영구적으로 삭제됩니다.
                    </p>
                </div>
            </div>
        </div>

        <!-- 삭제 정보 -->
        <div class="mb-8 bg-white border border-gray-200 rounded-lg p-6">
            <h3 class="text-lg font-bold text-[#1a1a2e] mb-4">삭제될 정보</h3>

            <div class="space-y-3">
                <div class="flex justify-between items-center pb-3 border-b border-gray-100">
                    <span class="text-gray-600">게시판 이름</span>
                    <span class="font-semibold text-[#1a1a2e]">{{ board.name }}</span>
                </div>

                <div class="flex justify-between items-center pb-3 border-b border-gray-100">
                    <span class="text-gray-600">게시판 ID</span>
                    <span class="font-semibold text-[#1a1a2e]">{{ board.id }}</span>
                </div>

                <div class="flex justify-between items-center pb-3 border-b border-gray-100">
                    <span class="text-gray-600">포함된 레코드</span>
                    <span class="font-semibold text-red-600 text-lg">{{ record_count }}개</span>
                </div>

                <div class="flex justify-between items-center">
                    <span class="text-gray-600">생성 날짜</span>
                    <span class="font-semibold text-[#1a1a2e]">{{ board.created_at[:10] if board.created_at else '-' }}</span>
                </div>
            </div>
        </div>

        <!-- 확인 입력 -->
        <div class="mb-8 bg-white border border-gray-200 rounded-lg p-6">
            <h3 class="text-lg font-bold text-[#1a1a2e] mb-4">확인</h3>

            <p class="text-gray-600 text-sm mb-4">
                실수로 인한 삭제를 방지하기 위해 게시판 이름을 정확히 입력해주세요:
            </p>

            <div class="mb-4">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3">
                    <code class="text-red-600 font-semibold text-sm">{{ board.name }}</code>
                </div>

                <input
                    type="text"
                    id="confirmInput"
                    placeholder="게시판 이름을 입력하세요"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                />
            </div>

            <!-- 에러 메시지 (숨겨짐) -->
            <div id="errorMessage" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                게시판 이름이 일치하지 않습니다.
            </div>
        </div>

        <!-- 버튼 -->
        <div class="flex gap-3">
            <a href="/"
                class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition-colors text-center">
                취소
            </a>
            <button
                type="button"
                id="deleteBtn"
                class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                게시판 삭제
            </button>
        </div>

        <!-- 보안 안내 -->
        <div class="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-blue-700 text-xs leading-relaxed">
                <strong>📌 안내:</strong> 이 작업을 수행하면 게시판 및 포함된 {{ record_count }}개의 모든 레코드가 영구적으로 삭제됩니다.
                데이터 복구는 불가능하므로 신중하게 진행해주세요.
            </p>
        </div>
    </div>

    <script>
        // 1. 확인 입력 감시
        const confirmInput = document.getElementById('confirmInput');
        const deleteBtn = document.getElementById('deleteBtn');
        const errorMessage = document.getElementById('errorMessage');
        const boardName = '{{ board.name }}';

        confirmInput.addEventListener('input', (e) => {
            console.log(`[DELETE-CONFIRM] 입력값 검증: "${e.target.value}" vs "${boardName}"`);

            const matches = e.target.value === boardName;
            deleteBtn.disabled = !matches;

            if (e.target.value && !matches) {
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        });

        // 2. 삭제 버튼 클릭 핸들러
        deleteBtn.addEventListener('click', async () => {
            console.log(`[DELETE-CONFIRM] 최종 삭제 확인: board_id={{ board.id }}`);

            if (confirmInput.value !== boardName) {
                alert('게시판 이름이 일치하지 않습니다.');
                return;
            }

            // 3. 최종 확인
            if (!confirm(`정말로 게시판 "${boardName}"을(를) 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) {
                console.log('[DELETE-CONFIRM] 사용자가 최종 삭제를 취소함');
                return;
            }

            console.log('[DELETE-CONFIRM] 최종 삭제 진행 중...');

            try {
                // 4. DELETE 요청
                const response = await fetch(`/boards/{{ board.id }}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`DELETE 응답 오류: ${response.status}`);
                }

                console.log('[DELETE-CONFIRM] ✓ 삭제 완료 - 대시보드로 리다이렉트');
                alert('게시판이 성공적으로 삭제되었습니다.');
                window.location.href = '/';

            } catch (error) {
                console.error('[DELETE-CONFIRM] 오류:', error);
                alert('게시판 삭제 중 오류가 발생했습니다.');
            }
        });

        // 5. 페이지 로드 시 입력 필드에 포커스
        window.addEventListener('load', () => {
            confirmInput.focus();
        });
    </script>
{% endblock %}
