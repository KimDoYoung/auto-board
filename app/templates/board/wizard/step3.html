{% extends "base.html" %}

{% block title %}Step 3: 입력폼 설정 - Auto-Board{% endblock %}

{% block content %}
{% include 'common/nav.html' %}

<div class="p-8 max-w-5xl mx-auto w-full">
    <div class="space-y-8">
        <!-- Progress Indicator -->
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">단계 3/5: 입력폼 설정</span>
                    <span class="text-sm text-gray-500">60%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full w-3/5 bg-indigo-500 rounded-full transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <!-- Board Info -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-6">
            <p class="text-sm text-indigo-700">
                <span class="font-semibold">{{ board.name }}</span> (ID: {{ board.id }})
            </p>
        </div>

        <!-- Form Configuration -->
        <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
            <h2 class="text-2xl font-bold text-[#1a1a2e] mb-6 border-b pb-4">입력폼 설정</h2>

            <div class="space-y-4 mb-8" id="fieldsContainer">
                <!-- Fields will be added dynamically -->
            </div>

            <!-- Add Field Selector -->
            <div class="flex gap-2 items-end">
                <div class="flex-1">
                    <label class="block text-gray-700 font-medium text-sm mb-2">필드 추가</label>
                    <select id="fieldSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                        <option value="">-- 추가할 필드 선택 --</option>
                    </select>
                </div>
                <button type="button" onclick="wizardStep3.addSelectedField()"
                    class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-medium text-sm transition-colors">
                    추가
                </button>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between gap-4">
            <a id="prevStepBtn" href="/boards/new/step2/"
                class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition-colors">
                이전 단계(리스트 설정)
            </a>
            <button type="button" onclick="wizardStep3.submit()"
                class="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transform active:scale-95 transition-all">
                다음 단계 (보기 설정)
            </button>
        </div>
    </div>
</div>

<script>
// Variables from Jinja2 template - Define as window properties for global access
window.allColumns = {{ columns | tojson }};
window.createEditConfig = {{ create_edit_config | tojson if create_edit_config else 'null' }};
window.boardData = {{ board | tojson }};
window.boardId = {{ board.id }};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('\n[STEP3-INIT] DOMContentLoaded 이벤트 발생');

    // [0] 네비게이션 링크 설정
    const prevBtn = document.getElementById('prevStepBtn');
    if (prevBtn) {
        prevBtn.href = `/boards/new/step2/${window.boardId}`;
    }

    // [1] 필드 선택기(fieldSelector) 채우기
    console.log('\n[1] 필드 선택기 채우기...');
    const selector = document.getElementById('fieldSelector');

    window.allColumns.forEach((column, idx) => {
        const option = document.createElement('option');
        option.value = column.name;
        option.textContent = `${column.label} (${column.name})`;
        selector.appendChild(option);
        console.log(`[1] ${idx + 1}. ${column.label} (${column.name})`);
    });
    console.log(`[1] ✓ 총 ${window.allColumns.length}개 컬럼 추가됨`);

    // [1-1] is_file_attach가 true이면 파일 필드를 selector에 추가
    if (window.boardData && window.boardData.is_file_attach) {
        console.log('\n[1-1] is_file_attach = true → 파일 필드 추가');
        const fileOption = document.createElement('option');
        fileOption.value = 'attachment';
        fileOption.textContent = '첨부파일 (attachment)';
        selector.appendChild(fileOption);
        console.log('[1-1] ✓ 첨부파일 필드 추가됨');
    } else {
        console.log('\n[1-1] is_file_attach = false 또는 없음');
    }

    // [2] 기존 설정이 있으면 로드 (edit mode)
    console.log('\n[2] 기존 설정 확인...');
    const fieldsToLoad = window.createEditConfig && (window.createEditConfig.columns || window.createEditConfig.fields) || null;

    if (fieldsToLoad && fieldsToLoad.length > 0) {
        console.log(`[2] ✓ EDIT MODE - 기존 필드 ${fieldsToLoad.length}개 로드`);
        console.log('[2] 기존 필드 목록:', fieldsToLoad.map(f => f.name));

        fieldsToLoad.forEach((fieldData, fieldIdx) => {
            console.log(`\n[2-${fieldIdx}] 필드 로드: ${fieldData.name}`);
            console.log(`[2-${fieldIdx}] 저장된 데이터:`, fieldData);

            wizardStep3.addField(fieldData.name);

            // 필드별 설정값 적용
            const lastField = document.querySelector('[data-field-index]:last-of-type');
            if (lastField) {
                const elementTypeSelect = lastField.querySelector('.field-element-type');
                const dataType = lastField.querySelector('.field-data-type').value;

                // [1] 엘리먼트 타입 설정 (HTML Editor 처리)
                let elementToSet = fieldData.element;
                let useHtmlEditor = false;

                if (fieldData.element === 'html_editor' && fieldData.element_type === 'html_editor') {
                    elementToSet = 'textarea';
                    useHtmlEditor = true;
                    console.log(`[2-${fieldIdx}] HTML Editor 감지 - textarea로 변환`);
                }

                // 동적으로 생성된 옵션 중에서 해당 element 선택
                if (elementTypeSelect) {
                    elementTypeSelect.value = elementToSet;
                    console.log(`[2-${fieldIdx}] ✓ Element 타입 설정: ${elementToSet}`);
                }

                // [2] 기본 필드 설정
                lastField.querySelector('.field-required').checked = fieldData.required || false;
                lastField.querySelector('.field-width').value = fieldData.width || '100%';
                lastField.querySelector('.field-help-text').value = fieldData.help_text || '';
                lastField.querySelector('.field-inline-group').value = fieldData.inline_group || '';
                console.log(`[2-${fieldIdx}] ✓ 기본 필드 설정 완료`);

                // [3] Min/Max 값 설정
                if (fieldData.min_value !== undefined) {
                    lastField.querySelector('.field-min-value').value = fieldData.min_value;
                    console.log(`[2-${fieldIdx}] ✓ Min 값: ${fieldData.min_value}`);
                }
                if (fieldData.max_value !== undefined) {
                    lastField.querySelector('.field-max-value').value = fieldData.max_value;
                    console.log(`[2-${fieldIdx}] ✓ Max 값: ${fieldData.max_value}`);
                }

                // [4] Select 타입: options 복원
                if (fieldData.element === 'select' && fieldData.options) {
                    console.log(`[2-${fieldIdx}] Select 타입 - ${fieldData.options.length}개 옵션 복원 중...`);
                    const optionsList = lastField.querySelector('[data-options-list]');
                    if (optionsList) {
                        fieldData.options.forEach((opt, optIdx) => {
                            wizardStep3.addSelectOption(lastField.dataset.fieldIndex);
                            const lastOption = optionsList.lastElementChild;
                            if (lastOption) {
                                lastOption.querySelector('.select-option-value').value = opt.value;
                                lastOption.querySelector('.select-option-label').value = opt.label;
                                console.log(`[2-${fieldIdx}]   - 옵션 ${optIdx + 1}: ${opt.value} / ${opt.label}`);
                            }
                        });
                    }
                }

                // [5] Checkbox 타입: default_value 복원
                if (fieldData.element === 'checkbox' && fieldData.default_value !== undefined) {
                    const defaultValue = fieldData.default_value === true ? 'true' : 'false';
                    const radio = lastField.querySelector(`input[name="checkbox-default-${lastField.dataset.fieldIndex}"][value="${defaultValue}"]`);
                    if (radio) {
                        radio.checked = true;
                        console.log(`[2-${fieldIdx}] ✓ Checkbox 기본값: ${defaultValue}`);
                    }
                }

                // [6] HTML Editor 사용 여부 복원
                if (useHtmlEditor) {
                    const htmlEditorCheckbox = lastField.querySelector('.field-use-html-editor');
                    if (htmlEditorCheckbox) {
                        htmlEditorCheckbox.checked = true;
                        console.log(`[2-${fieldIdx}] ✓ HTML Editor 활성화`);
                    }
                }

                // [7] 초기값 설정
                if (fieldData.default_value && fieldData.element !== 'checkbox' && fieldData.element !== 'html_editor') {
                    lastField.querySelector('.field-default-value').value = fieldData.default_value;
                    console.log(`[2-${fieldIdx}] ✓ 기본값: ${fieldData.default_value}`);
                }

                // [8] 조건부 UI 업데이트 (옵션/체크박스 표시)
                wizardStep3.updateFieldOptions(lastField.dataset.fieldIndex);
                console.log(`[2-${fieldIdx}] ✓ UI 업데이트 완료`);
            }
        });

        // [3] selector 옵션 업데이트 (추가된 필드들은 숨기기)
        console.log('\n[3] Selector 옵션 업데이트 중...');
        wizardStep3.updateSelectorOptions();
        console.log('[3] ✓ 완료');

        console.log('\n[STEP3-INIT] ✅ EDIT MODE 초기화 완료\n');
    } else {
        // [2-1] 새로 생성하는 mode - 처음부터 모든 필드를 추가
        console.log('[2] ✓ CREATE MODE - 모든 필드 추가');
        window.allColumns.forEach((column, idx) => {
            console.log(`[2] ${idx + 1}. ${column.label} (${column.name}) 추가 중...`);
            wizardStep3.addField(column.name);
        });
        console.log(`[2] ✓ 총 ${window.allColumns.length}개 필드 추가됨`);

        // [2-2] is_file_attach가 true이면 파일 필드도 자동 추가
        if (window.boardData && window.boardData.is_file_attach) {
            console.log('\n[2-2] is_file_attach = true → 파일 필드 자동 추가');
            wizardStep3.addField('attachment');
            console.log('[2-2] ✓ 첨부파일 필드 추가 완료');
        } else {
            console.log('[2-2] is_file_attach = false 또는 없음');
        }

        console.log('\n[STEP3-INIT] ✅ CREATE MODE 초기화 완료\n');
    }
});
</script>

<script src="/static/js/wizard/step3_create_edit.js"></script>
{% endblock %}
