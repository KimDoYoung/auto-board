{% extends "base.html" %}

{% block title %}Step 4: ìƒì„¸ë³´ê¸° ì„¤ì • - Auto-Board{% endblock %}

{% block content %}
{% include 'common/nav.html' %}

<div class="p-8 max-w-6xl mx-auto w-full">
    <div class="space-y-8">
        <!-- Progress Indicator -->
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">ë‹¨ê³„ 4/4: ìƒì„¸ë³´ê¸° ì„¤ì •</span>
                    <span class="text-sm text-gray-500">100%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full w-full bg-indigo-500 rounded-full transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <!-- Board Info -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-6">
            <p class="text-sm text-indigo-700">
                <span class="font-semibold">{{ board.name }}</span> (ID: {{ board.id }})
            </p>
        </div>

        <!-- Main Configuration -->
        <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
            <h2 class="text-2xl font-bold text-[#1a1a2e] mb-6 border-b pb-4">ìƒì„¸ë³´ê¸°(View) ì„¤ì •</h2>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8 text-sm text-blue-700">
                <p class="font-semibold mb-1">ğŸ’¡ íŒ:</p>
                <p>ê¸°ë¡ì„ ìƒì„¸ë³´ê¸°í•  ë•Œ ê° í•„ë“œë¥¼ ì–´ë–»ê²Œ í‘œì‹œí• ì§€ ì„¤ì •í•©ë‹ˆë‹¤. í•„ë“œì˜ ìˆœì„œ, ê·¸ë£¹í•‘, ìŠ¤íƒ€ì¼, í¬ë§·ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div id="fieldsContainer" class="space-y-6 mb-8">
                <!-- Fields will be dynamically generated here -->
            </div>

            <!-- Add Section Button -->
            <button onclick="viewStep4.addSection()"
                class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 font-medium text-sm transition-colors flex items-center gap-2 mb-8">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                ì„¹ì…˜ ì¶”ê°€
            </button>

            <!-- Field Type Reference -->
            <div class="bg-gray-50 p-4 rounded-lg text-sm text-gray-600">
                <p class="font-semibold mb-2">í‘œì‹œ íƒ€ì…:</p>
                <ul class="grid grid-cols-2 gap-2 text-xs">
                    <li><span class="font-mono bg-white px-2 py-1 rounded">text</span> - ì¼ë°˜ í…ìŠ¤íŠ¸</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">date</span> - ë‚ ì§œ (í¬ë§· ê°€ëŠ¥)</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">datetime</span> - ë‚ ì§œ+ì‹œê°„</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">stars</span> - ë³„ì  í‘œì‹œ</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">currency</span> - í†µí™” í‘œì‹œ</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">boolean</span> - ì°¸/ê±°ì§“</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">badge</span> - ë°°ì§€ (ìƒ‰ìƒ ë§µ)</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">html</span> - HTML ì½˜í…ì¸ </li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">list</span> - ëª©ë¡/ë°°ì§€ ëª©ë¡</li>
                    <li><span class="font-mono bg-white px-2 py-1 rounded">file_link</span> - íŒŒì¼ ë§í¬</li>
                </ul>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
            <h3 class="text-xl font-bold text-[#1a1a2e] mb-4 border-b pb-3">JSON ë¯¸ë¦¬ë³´ê¸°</h3>
            <pre class="bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto text-xs font-mono" id="jsonPreview">
{
  "display_fields": []
}</pre>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between gap-4">
            <a href="/boards/new/step3/{{ board.id }}"
                class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition-colors">
                ì´ì „ ë‹¨ê³„
            </a>
            <button onclick="viewStep4.submit()"
                class="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transform active:scale-95 transition-all">
                ë§ˆë¬´ë¦¬ (ì™„ë£Œ)
            </button>
        </div>
    </div>
</div>

<style>
.field-card {
    @apply bg-white p-4 rounded-lg border border-gray-200 space-y-3;
}
.field-card.section-header {
    @apply bg-gray-50 border-gray-300;
}
</style>

<script>
// Variables from Jinja2 template
const columnsData = JSON.parse('{{ columns|tojson|safe }}');
const viewConfig = {{ create_config | tojson if create_config else 'null' }};
const boardData = {{ board | tojson }};

console.log('\n' + '='.repeat(60));
console.log('[STEP4-INIT-0] Step 4 ì´ˆê¸°í™” ì‹œì‘');
console.log('='.repeat(60));
console.log('[STEP4-INIT-0-1] Board ì •ë³´:', boardData);
console.log('[STEP4-INIT-0-2] ì»¬ëŸ¼ ë°ì´í„°:', columnsData);
console.log('[STEP4-INIT-0-3] ê¸°ì¡´ view config:', viewConfig);

const viewStep4 = {
    sectionCount: 0,
    fieldCount: {},
    columns: columnsData,
    isEditMode: false,

    init() {
        console.log('\n[STEP4-INIT-1] init() ì‹¤í–‰ ì¤‘...');

        // ê¸°ì¡´ ì„¤ì •ì´ ìˆëŠ”ì§€ í™•ì¸ (edit mode)
        if (viewConfig && viewConfig.display_fields && viewConfig.display_fields.length > 0) {
            console.log('[STEP4-INIT-2] EDIT MODE ê°ì§€ - ê¸°ì¡´ view ì„¤ì • ë¡œë“œ');
            this.isEditMode = true;
            this.loadExistingConfig();
        } else {
            console.log('[STEP4-INIT-2] CREATE MODE - ìƒˆë¡œìš´ ì„¤ì • ìƒì„±');
            this.isEditMode = false;
            // Initialize with default section
            this.addSection();
            this.populateFieldsFromColumns();
        }

        this.updateJsonPreview();
        console.log('[STEP4-INIT-3] âœ“ ì´ˆê¸°í™” ì™„ë£Œ');
    },

    loadExistingConfig() {
        console.log('[STEP4-INIT-2-1] ê¸°ì¡´ view ì„¤ì • ë¡œë“œ ì‹œì‘');

        // ì„¹ì…˜ë³„ë¡œ í•„ë“œë¥¼ ê·¸ë£¹í™”
        const sectionMap = {};
        viewConfig.display_fields.forEach(field => {
            const section = field.section || 'default';
            if (!sectionMap[section]) {
                sectionMap[section] = {
                    title: field.section_title || '',
                    fields: []
                };
            }
            sectionMap[section].fields.push(field);
            console.log(`[STEP4-INIT-2-1-${Object.keys(sectionMap).length}] í•„ë“œ ë¡œë“œ: ${field.name} (ì„¹ì…˜: ${section})`);
        });

        // ê° ì„¹ì…˜ ì¶”ê°€
        Object.entries(sectionMap).forEach(([sectionId, sectionData]) => {
            console.log(`[STEP4-INIT-2-2] ì„¹ì…˜ ì¶”ê°€: ${sectionId || 'default'}`);
            this.addSection();

            const sectionEl = document.querySelector(`[data-section-index="${this.sectionCount}"]`);
            if (sectionEl && sectionData.title) {
                sectionEl.querySelector('.section-title').value = sectionData.title;
                console.log(`[STEP4-INIT-2-2-1] ì„¹ì…˜ ì œëª©: ${sectionData.title}`);
            }

            // ì„¹ì…˜ì˜ í•„ë“œë“¤ ì¶”ê°€
            sectionData.fields.forEach((fieldData, fieldIdx) => {
                console.log(`[STEP4-INIT-2-3-${fieldIdx}] í•„ë“œ UI ìƒì„±: ${fieldData.name}`);
                this.addField(this.sectionCount);

                const fieldsContainer = document.querySelector(`[data-section-fields="${this.sectionCount}"]`);
                const fieldEl = fieldsContainer.lastElementChild;

                if (fieldEl) {
                    // ê¸°ë³¸ í•„ë“œ ì„¤ì •
                    const nameSelect = fieldEl.querySelector('.field-name');
                    if (nameSelect) {
                        nameSelect.value = fieldData.name;
                        console.log(`[STEP4-INIT-2-3-${fieldIdx}] âœ“ í•„ë“œëª…: ${fieldData.name}`);
                    }

                    const labelInput = fieldEl.querySelector('.field-label');
                    if (labelInput) {
                        labelInput.value = fieldData.label || fieldData.name;
                        console.log(`[STEP4-INIT-2-3-${fieldIdx}] âœ“ ë¼ë²¨: ${fieldData.label}`);
                    }

                    const displayTypeSelect = fieldEl.querySelector('.field-display-type');
                    if (displayTypeSelect) {
                        displayTypeSelect.value = fieldData.display_type;
                        console.log(`[STEP4-INIT-2-3-${fieldIdx}] âœ“ í‘œì‹œíƒ€ì…: ${fieldData.display_type}`);
                        // ì¡°ê±´ë¶€ ì˜µì…˜ ìƒì„±
                        displayTypeSelect.dispatchEvent(new Event('change'));
                    }

                    // ì„ íƒì  í•„ë“œ ë³µì›
                    if (fieldData.width) {
                        fieldEl.querySelector('.field-width').value = fieldData.width;
                        console.log(`[STEP4-INIT-2-3-${fieldIdx}] âœ“ ë„ˆë¹„: ${fieldData.width}`);
                    }

                    if (fieldData.inline_group) {
                        fieldEl.querySelector('.field-inline-group').value = fieldData.inline_group;
                        console.log(`[STEP4-INIT-2-3-${fieldIdx}] âœ“ ì¸ë¼ì¸ê·¸ë£¹: ${fieldData.inline_group}`);
                    }

                    if (fieldData.full_width) {
                        fieldEl.querySelector('.field-full-width').checked = true;
                        console.log(`[STEP4-INIT-2-3-${fieldIdx}] âœ“ ì „ì²´ë„ˆë¹„: true`);
                    }

                    if (fieldData.hide_label) {
                        fieldEl.querySelector('.field-hide-label').checked = true;
                        console.log(`[STEP4-INIT-2-3-${fieldIdx}] âœ“ ë¼ë²¨ìˆ¨ê¸°ê¸°: true`);
                    }

                    if (fieldData.style_class) {
                        fieldEl.querySelector('.field-style-class').value = fieldData.style_class;
                        console.log(`[STEP4-INIT-2-3-${fieldIdx}] âœ“ ìŠ¤íƒ€ì¼: ${fieldData.style_class}`);
                    }

                    // Display type ë³„ ì˜µì…˜ ë³µì›
                    this.restoreDisplayTypeOptions(fieldEl, fieldData);
                }
            });
        });

        console.log('[STEP4-INIT-2-4] âœ“ ê¸°ì¡´ ì„¤ì • ëª¨ë‘ ë¡œë“œ ì™„ë£Œ');
    },

    restoreDisplayTypeOptions(fieldEl, fieldData) {
        const displayType = fieldData.display_type;
        const optionsContainer = fieldEl.querySelector('[id^="displayTypeOptions_"]');
        if (!optionsContainer) return;

        console.log(`[STEP4-INIT-OPT] ${fieldData.name}ì˜ ì˜µì…˜ ë³µì› (íƒ€ì…: ${displayType})`);

        if (displayType === 'date' && fieldData.format) {
            const formatInput = optionsContainer.querySelector('.field-format');
            if (formatInput) {
                formatInput.value = fieldData.format;
                console.log(`[STEP4-INIT-OPT]   - format: ${fieldData.format}`);
            }
        } else if (displayType === 'datetime') {
            if (fieldData.format) {
                const formatInput = optionsContainer.querySelector('.field-format');
                if (formatInput) {
                    formatInput.value = fieldData.format;
                    console.log(`[STEP4-INIT-OPT]   - format: ${fieldData.format}`);
                }
            }
            if (fieldData.relative) {
                const relativeCheckbox = optionsContainer.querySelector('.field-relative');
                if (relativeCheckbox) {
                    relativeCheckbox.checked = true;
                    console.log(`[STEP4-INIT-OPT]   - relative: true`);
                }
            }
        } else if (displayType === 'stars') {
            if (fieldData.max_stars) {
                const maxStarsInput = optionsContainer.querySelector('.field-max-stars');
                if (maxStarsInput) {
                    maxStarsInput.value = fieldData.max_stars;
                    console.log(`[STEP4-INIT-OPT]   - max_stars: ${fieldData.max_stars}`);
                }
            }
            if (fieldData.show_number) {
                const showNumberCheckbox = optionsContainer.querySelector('.field-show-number');
                if (showNumberCheckbox) {
                    showNumberCheckbox.checked = true;
                    console.log(`[STEP4-INIT-OPT]   - show_number: true`);
                }
            }
        } else if (displayType === 'currency') {
            if (fieldData.currency_code) {
                const currencyInput = optionsContainer.querySelector('.field-currency-code');
                if (currencyInput) {
                    currencyInput.value = fieldData.currency_code;
                    console.log(`[STEP4-INIT-OPT]   - currency_code: ${fieldData.currency_code}`);
                }
            }
            if (fieldData.decimal_places !== undefined) {
                const decimalInput = optionsContainer.querySelector('.field-decimal-places');
                if (decimalInput) {
                    decimalInput.value = fieldData.decimal_places;
                    console.log(`[STEP4-INIT-OPT]   - decimal_places: ${fieldData.decimal_places}`);
                }
            }
            if (fieldData.thousands_separator) {
                const separatorCheckbox = optionsContainer.querySelector('.field-thousands-separator');
                if (separatorCheckbox) {
                    separatorCheckbox.checked = true;
                    console.log(`[STEP4-INIT-OPT]   - thousands_separator: true`);
                }
            }
        } else if (displayType === 'boolean') {
            if (fieldData.true_text) {
                const trueTextInput = optionsContainer.querySelector('.field-true-text');
                if (trueTextInput) {
                    trueTextInput.value = fieldData.true_text;
                    console.log(`[STEP4-INIT-OPT]   - true_text: ${fieldData.true_text}`);
                }
            }
            if (fieldData.false_text) {
                const falseTextInput = optionsContainer.querySelector('.field-false-text');
                if (falseTextInput) {
                    falseTextInput.value = fieldData.false_text;
                    console.log(`[STEP4-INIT-OPT]   - false_text: ${fieldData.false_text}`);
                }
            }
            if (fieldData.true_class) {
                const trueClassInput = optionsContainer.querySelector('.field-true-class');
                if (trueClassInput) {
                    trueClassInput.value = fieldData.true_class;
                    console.log(`[STEP4-INIT-OPT]   - true_class: ${fieldData.true_class}`);
                }
            }
            if (fieldData.false_class) {
                const falseClassInput = optionsContainer.querySelector('.field-false-class');
                if (falseClassInput) {
                    falseClassInput.value = fieldData.false_class;
                    console.log(`[STEP4-INIT-OPT]   - false_class: ${fieldData.false_class}`);
                }
            }
            if (fieldData.show_icon) {
                const showIconCheckbox = optionsContainer.querySelector('.field-show-icon');
                if (showIconCheckbox) {
                    showIconCheckbox.checked = true;
                    console.log(`[STEP4-INIT-OPT]   - show_icon: true`);
                }
            }
        } else if (displayType === 'badge' && fieldData.badge_color_map) {
            const colorMapTextarea = optionsContainer.querySelector('.field-badge-color-map');
            if (colorMapTextarea) {
                colorMapTextarea.value = JSON.stringify(fieldData.badge_color_map, null, 2);
                console.log(`[STEP4-INIT-OPT]   - badge_color_map: ${JSON.stringify(fieldData.badge_color_map)}`);
            }
        } else if (displayType === 'html' && fieldData.sanitize) {
            const sanitizeCheckbox = optionsContainer.querySelector('.field-sanitize');
            if (sanitizeCheckbox) {
                sanitizeCheckbox.checked = true;
                console.log(`[STEP4-INIT-OPT]   - sanitize: true`);
            }
        } else if (displayType === 'list') {
            if (fieldData.display_as) {
                const displayAsSelect = optionsContainer.querySelector('.field-display-as');
                if (displayAsSelect) {
                    displayAsSelect.value = fieldData.display_as;
                    console.log(`[STEP4-INIT-OPT]   - display_as: ${fieldData.display_as}`);
                }
            }
            if (fieldData.separator) {
                const separatorInput = optionsContainer.querySelector('.field-separator');
                if (separatorInput) {
                    separatorInput.value = fieldData.separator;
                    console.log(`[STEP4-INIT-OPT]   - separator: ${fieldData.separator}`);
                }
            }
            if (fieldData.hide_if_empty) {
                const hideIfEmptyCheckbox = optionsContainer.querySelector('.field-hide-if-empty');
                if (hideIfEmptyCheckbox) {
                    hideIfEmptyCheckbox.checked = true;
                    console.log(`[STEP4-INIT-OPT]   - hide_if_empty: true`);
                }
            }
        } else if (displayType === 'file_link') {
            if (fieldData.show_size) {
                const showSizeCheckbox = optionsContainer.querySelector('.field-show-size');
                if (showSizeCheckbox) {
                    showSizeCheckbox.checked = true;
                    console.log(`[STEP4-INIT-OPT]   - show_size: true`);
                }
            }
            if (fieldData.show_icon) {
                const showIconCheckbox = optionsContainer.querySelector('.field-show-icon');
                if (showIconCheckbox) {
                    showIconCheckbox.checked = true;
                    console.log(`[STEP4-INIT-OPT]   - show_icon: true`);
                }
            }
            if (fieldData.download) {
                const downloadCheckbox = optionsContainer.querySelector('.field-download');
                if (downloadCheckbox) {
                    downloadCheckbox.checked = true;
                    console.log(`[STEP4-INIT-OPT]   - download: true`);
                }
            }
        }
    },

    populateFieldsFromColumns() {
        console.log('[STEP4-INIT-3-1] populateFieldsFromColumns ì‹œì‘');

        if (this.columns && this.columns.length > 0) {
            const fieldsContainer = document.querySelector('[data-section-fields="1"]');
            console.log(`[STEP4-INIT-3-2] ì´ ${this.columns.length}ê°œ ì»¬ëŸ¼ ë°œê²¬`);

            this.columns.forEach((col, idx) => {
                console.log(`[STEP4-INIT-3-3-${idx}] í•„ë“œ ì¶”ê°€: ${col.name} (${col.label})`);
                this.addField(1, col);
            });

            console.log('[STEP4-INIT-3-4] âœ“ populateFieldsFromColumns ì™„ë£Œ');
        }
    },

    getDefaultDisplayType(dataType) {
        const mapping = {
            'ymd': 'date',
            'datetime': 'datetime',
            'integer': 'text',
            'float': 'currency',
            'boolean': 'boolean',
            'text': 'html',
            'string': 'text'
        };
        return mapping[dataType] || 'text';
    },

    addSection() {
        this.sectionCount++;
        const container = document.getElementById('fieldsContainer');

        const section = document.createElement('div');
        section.className = 'bg-gray-50 rounded-lg p-6 space-y-4 border border-gray-200';
        section.dataset.sectionIndex = this.sectionCount;

        section.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <div class="flex-1">
                    <label class="block text-gray-700 font-medium text-sm mb-2">ì„¹ì…˜ ì œëª© (ì„ íƒ)</label>
                    <input type="text" class="section-title w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        placeholder="ì˜ˆ: ê¸°ë³¸ ì •ë³´, ìƒì„¸ ë‚´ìš©, ë©”íƒ€ì •ë³´">
                </div>
                <button onclick="viewStep4.removeSection(${this.sectionCount})" class="text-red-600 hover:text-red-700 font-semibold text-sm mt-6">
                    ì„¹ì…˜ ì‚­ì œ
                </button>
            </div>

            <div class="space-y-3" data-section-fields="${this.sectionCount}">
                <!-- Fields will be added here -->
            </div>

            <button onclick="viewStep4.addField(${this.sectionCount})"
                class="text-indigo-600 hover:text-indigo-700 font-medium text-sm flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                í•„ë“œ ì¶”ê°€
            </button>
        `;

        container.appendChild(section);
        this.fieldCount[this.sectionCount] = 0;
    },

    addField(sectionIndex, columnData = null) {
        this.fieldCount[sectionIndex]++;
        const fieldsContainer = document.querySelector(`[data-section-fields="${sectionIndex}"]`);

        const fieldIndex = this.fieldCount[sectionIndex];
        const fieldId = `field_${sectionIndex}_${fieldIndex}`;

        const field = document.createElement('div');
        field.className = 'field-card';
        field.dataset.fieldIndex = fieldIndex;
        field.dataset.sectionIndex = sectionIndex;
        field.dataset.fieldName = columnData ? columnData.name : '';

        // ë°ì´í„° íƒ€ì…ì— ë”°ë¼ ê¸°ë³¸ display_type ì„¤ì •
        const defaultDisplayType = columnData ? this.getDefaultDisplayType(columnData.data_type) : 'text';

        field.innerHTML = `
            <!-- í•„ë“œ ì¹´ë“œ í—¤ë” -->
            <div class="flex justify-between items-start gap-3 mb-4 pb-3 border-b">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="text-lg font-bold text-gray-800">${columnData ? columnData.label : 'í•„ë“œ'}</span>
                        <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">${columnData ? columnData.data_type : 'unknown'}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">í•„ë“œëª…: <code>${columnData ? columnData.name : '-'}</code></p>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="viewStep4.removeField(this)"
                        class="px-3 py-1 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 rounded transition">
                        âœ• ì œê±°
                    </button>
                </div>
            </div>

            <!-- Row 1: ê¸°ë³¸ í‘œì‹œ ì„¤ì • -->
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 font-medium text-sm mb-2">í‘œì‹œ íƒ€ì…</label>
                    <select class="field-display-type w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        onchange="viewStep4.updateDisplayTypeOptions(this)">
                        <option value="text">text (í…ìŠ¤íŠ¸)</option>
                        <option value="date">date (ë‚ ì§œ)</option>
                        <option value="datetime">datetime (ë‚ ì§œì‹œê°„)</option>
                        <option value="stars">stars (ë³„ì )</option>
                        <option value="currency">currency (í†µí™”)</option>
                        <option value="boolean">boolean (ì°¸/ê±°ì§“)</option>
                        <option value="badge">badge (ë°°ì§€)</option>
                        <option value="html">html (HTML)</option>
                        <option value="list">list (ëª©ë¡)</option>
                        <option value="file_link">file_link (íŒŒì¼ë§í¬)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-medium text-sm mb-2">ë„ˆë¹„</label>
                    <input type="text" class="field-width w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        placeholder="ì˜ˆ: 30%, auto, 100%">
                </div>

                <div>
                    <label class="block text-gray-700 font-medium text-sm mb-2">ë¼ë²¨ í…ìŠ¤íŠ¸</label>
                    <input type="text" class="field-label w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        placeholder="í‘œì‹œí•  ë¼ë²¨" value="${columnData ? (columnData.label || columnData.name) : ''}">
                </div>
            </div>

            <!-- Row 2: ë ˆì´ì•„ì›ƒ ì˜µì…˜ -->
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 font-medium text-sm mb-2">ì¸ë¼ì¸ ê·¸ë£¹</label>
                    <input type="text" class="field-inline-group w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                        placeholder="ì˜ˆ: header, meta, footer">
                </div>

                <div class="flex items-end gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-full-width w-4 h-4 text-indigo-600 rounded">
                        <span class="text-gray-700 text-sm font-medium">ì „ì²´ ë„ˆë¹„</span>
                    </label>
                </div>

                <div class="flex items-end gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-hide-label w-4 h-4 text-indigo-600 rounded">
                        <span class="text-gray-700 text-sm font-medium">ë¼ë²¨ ìˆ¨ê¸°ê¸°</span>
                    </label>
                </div>
            </div>

            <!-- Row 3: ìŠ¤íƒ€ì¼ ì„¤ì • -->
            <div class="mb-4">
                <label class="block text-gray-700 font-medium text-sm mb-2">ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤</label>
                <select class="field-style-class w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                    <option value="">ì„ íƒ ì•ˆ í•¨</option>
                    <option value="field-title">field-title (í° ì œëª©)</option>
                    <option value="field-subtitle">field-subtitle (ì¤‘ê°„ ì œëª©)</option>
                    <option value="field-heading">field-heading (ì†Œì œëª©)</option>
                    <option value="field-normal">field-normal (ì¼ë°˜ í…ìŠ¤íŠ¸)</option>
                    <option value="field-small">field-small (ì‘ì€ í…ìŠ¤íŠ¸)</option>
                    <option value="field-tiny">field-tiny (ë§¤ìš° ì‘ì€ í…ìŠ¤íŠ¸)</option>
                    <option value="field-highlight">field-highlight (ê°•ì¡°)</option>
                    <option value="field-important">field-important (ì¤‘ìš”)</option>
                    <option value="field-info">field-info (ì •ë³´)</option>
                    <option value="field-success">field-success (ì„±ê³µ)</option>
                    <option value="field-warning">field-warning (ê²½ê³ )</option>
                    <option value="field-danger">field-danger (ìœ„í—˜)</option>
                    <option value="field-card">field-card (ì¹´ë“œ)</option>
                    <option value="field-divider">field-divider (êµ¬ë¶„ì„ )</option>
                </select>
            </div>

            <!-- Display typeë³„ ì˜µì…˜ -->
            <div id="displayTypeOptions_${sectionIndex}_${fieldIndex}" class="space-y-3 mb-4 p-3 bg-gray-50 rounded-lg">
                <!-- Display type specific options will be added here -->
            </div>
        `;

        fieldsContainer.appendChild(field);

        // ê¸°ë³¸ display type ì„¤ì •
        const displayTypeSelect = field.querySelector('.field-display-type');
        displayTypeSelect.value = defaultDisplayType;
        displayTypeSelect.dispatchEvent(new Event('change'));

        // Update preview on field change
        field.addEventListener('change', () => this.updateJsonPreview());
        field.addEventListener('input', () => this.updateJsonPreview());

        console.log(`[STEP4-INIT-ADD-FIELD] í•„ë“œ ì¶”ê°€ë¨: ${columnData ? columnData.name : 'unknown'} (index: ${fieldIndex})`);
    },

    updateDisplayTypeOptions(selectElement) {
        const displayType = selectElement.value;
        const fieldCard = selectElement.closest('.field-card');
        const sectionIndex = fieldCard.dataset.sectionIndex;
        const fieldIndex = fieldCard.dataset.fieldIndex;
        const optionsContainer = document.getElementById(`displayTypeOptions_${sectionIndex}_${fieldIndex}`);

        if (!optionsContainer) return;

        optionsContainer.innerHTML = '';

        if (displayType === 'date') {
            optionsContainer.innerHTML = `
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">ë‚ ì§œ í¬ë§·</label>
                    <input type="text" class="field-format w-full px-3 py-2 border border-gray-300 rounded text-sm"
                        placeholder="ì˜ˆ: YYYYë…„ MMì›” DDì¼" value="YYYY-MM-DD">
                </div>
            `;
        } else if (displayType === 'datetime') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ë‚ ì§œì‹œê°„ í¬ë§·</label>
                        <input type="text" class="field-format w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="ì˜ˆ: YYYY-MM-DD HH:mm" value="YYYY-MM-DD HH:mm">
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer mt-6">
                            <input type="checkbox" class="field-relative w-4 h-4 text-indigo-600 rounded">
                            <span class="text-gray-700 text-sm">ìƒëŒ€ ì‹œê°„ (2ì‹œê°„ ì „)</span>
                        </label>
                    </div>
                </div>
            `;
        } else if (displayType === 'stars') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ìµœëŒ€ ë³„ì </label>
                        <input type="number" class="field-max-stars w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="10" value="10" min="1" max="10">
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer mt-6">
                            <input type="checkbox" class="field-show-number w-4 h-4 text-indigo-600 rounded" checked>
                            <span class="text-gray-700 text-sm">ìˆ«ì í‘œì‹œ</span>
                        </label>
                    </div>
                </div>
            `;
        } else if (displayType === 'currency') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">í†µí™” ì½”ë“œ</label>
                        <input type="text" class="field-currency-code w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="KRW" value="KRW">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ì†Œìˆ˜ì </label>
                        <input type="number" class="field-decimal-places w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="0" value="0" min="0" max="3">
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer mt-6">
                            <input type="checkbox" class="field-thousands-separator w-4 h-4 text-indigo-600 rounded" checked>
                            <span class="text-gray-700 text-sm">ì²œë‹¨ìœ„ í‘œì‹œ</span>
                        </label>
                    </div>
                </div>
            `;
        } else if (displayType === 'boolean') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ì°¸ í…ìŠ¤íŠ¸</label>
                        <input type="text" class="field-true-text w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="ê³µê°œ" value="ê³µê°œ">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ê±°ì§“ í…ìŠ¤íŠ¸</label>
                        <input type="text" class="field-false-text w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="ë¹„ê³µê°œ" value="ë¹„ê³µê°œ">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ì°¸ ìƒ‰ìƒ</label>
                        <input type="text" class="field-true-class w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="text-green-600" value="text-green-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">ê±°ì§“ ìƒ‰ìƒ</label>
                        <input type="text" class="field-false-class w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder="text-gray-600" value="text-gray-600">
                    </div>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-show-icon w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-gray-700 text-sm">ì•„ì´ì½˜ í‘œì‹œ</span>
                    </label>
                </div>
            `;
        } else if (displayType === 'badge') {
            optionsContainer.innerHTML = `
                <div>
                    <label class="block text-gray-700 font-medium text-xs mb-1">ìƒ‰ìƒ ë§µ (JSON í˜•ì‹)</label>
                    <textarea class="field-badge-color-map w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono h-24"
                        placeholder='{"work": "blue", "personal": "green"}'></textarea>
                </div>
            `;
        } else if (displayType === 'html') {
            optionsContainer.innerHTML = `
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-sanitize w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-gray-700 text-sm">ìœ„í—˜í•œ ì½˜í…ì¸  ì œê±°</span>
                    </label>
                </div>
            `;
        } else if (displayType === 'list') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">í‘œì‹œ ë°©ì‹</label>
                        <select class="field-display-as w-full px-3 py-2 border border-gray-300 rounded text-sm">
                            <option value="badges">ë°°ì§€</option>
                            <option value="comma">ì‰¼í‘œ êµ¬ë¶„</option>
                            <option value="bullet">ê¸€ë¨¸ë¦¬</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium text-xs mb-1">êµ¬ë¶„ì</label>
                        <input type="text" class="field-separator w-full px-3 py-2 border border-gray-300 rounded text-sm"
                            placeholder=" " value=" ">
                    </div>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-hide-if-empty w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-gray-700 text-sm">ë¹„ì–´ìˆìœ¼ë©´ ìˆ¨ê¸°ê¸°</span>
                    </label>
                </div>
            `;
        } else if (displayType === 'file_link') {
            optionsContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="field-show-size w-4 h-4 text-indigo-600 rounded" checked>
                            <span class="text-gray-700 text-sm">íŒŒì¼ í¬ê¸° í‘œì‹œ</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="field-show-icon w-4 h-4 text-indigo-600 rounded" checked>
                            <span class="text-gray-700 text-sm">ì•„ì´ì½˜ í‘œì‹œ</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="field-download w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-gray-700 text-sm">ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥</span>
                    </label>
                </div>
            `;
        }

        // Re-attach change listeners
        optionsContainer.addEventListener('change', () => this.updateJsonPreview());
        optionsContainer.addEventListener('input', () => this.updateJsonPreview());
    },

    removeField(button) {
        button.closest('.field-card').remove();
        this.updateJsonPreview();
    },

    removeSection(sectionIndex) {
        document.querySelector(`[data-section-index="${sectionIndex}"]`).remove();
        this.updateJsonPreview();
    },

    updateJsonPreview() {
        const displayFields = [];

        document.querySelectorAll('[data-section-index]').forEach(sectionEl => {
            const sectionIndex = sectionEl.dataset.sectionIndex;
            const sectionTitle = sectionEl.querySelector('.section-title').value.trim() || null;

            sectionEl.querySelectorAll('.field-card:not(.section-header)').forEach(fieldEl => {
                const fieldName = fieldEl.querySelector('.field-name').value.trim();
                const fieldLabel = fieldEl.querySelector('.field-label').value.trim();
                const displayType = fieldEl.querySelector('.field-display-type').value;
                const width = fieldEl.querySelector('.field-width').value.trim() || null;
                const inlineGroup = fieldEl.querySelector('.field-inline-group').value.trim() || null;
                const fullWidth = fieldEl.querySelector('.field-full-width').checked;
                const hideLabel = fieldEl.querySelector('.field-hide-label').checked;
                const styleClass = fieldEl.querySelector('.field-style-class').value || null;
                const order = displayFields.length + 1;

                if (!fieldName) return;

                const field = {
                    name: fieldName,
                    label: fieldLabel || fieldName,
                    display_type: displayType,
                    order: order,
                    ...(width && { width }),
                    ...(inlineGroup && { inline_group: inlineGroup }),
                    ...(fullWidth && { full_width: true }),
                    ...(hideLabel && { hide_label: true }),
                    ...(styleClass && { style_class: styleClass }),
                    ...(sectionTitle && { section: `section_${sectionIndex}`, section_title: sectionTitle })
                };

                // Add display type specific options
                if (displayType === 'date') {
                    const format = fieldEl.querySelector('.field-format')?.value.trim();
                    if (format) field.format = format;
                } else if (displayType === 'datetime') {
                    const format = fieldEl.querySelector('.field-format')?.value.trim();
                    if (format) field.format = format;
                    const relative = fieldEl.querySelector('.field-relative')?.checked;
                    if (relative) field.relative = true;
                } else if (displayType === 'stars') {
                    const maxStars = fieldEl.querySelector('.field-max-stars')?.value;
                    if (maxStars) field.max_stars = parseInt(maxStars);
                    const showNumber = fieldEl.querySelector('.field-show-number')?.checked;
                    if (showNumber) field.show_number = true;
                } else if (displayType === 'currency') {
                    const currencyCode = fieldEl.querySelector('.field-currency-code')?.value.trim();
                    if (currencyCode) field.currency_code = currencyCode;
                    const decimalPlaces = fieldEl.querySelector('.field-decimal-places')?.value;
                    if (decimalPlaces !== undefined) field.decimal_places = parseInt(decimalPlaces);
                    const separator = fieldEl.querySelector('.field-thousands-separator')?.checked;
                    if (separator) field.thousands_separator = true;
                } else if (displayType === 'boolean') {
                    const trueText = fieldEl.querySelector('.field-true-text')?.value.trim();
                    if (trueText) field.true_text = trueText;
                    const falseText = fieldEl.querySelector('.field-false-text')?.value.trim();
                    if (falseText) field.false_text = falseText;
                    const trueClass = fieldEl.querySelector('.field-true-class')?.value.trim();
                    if (trueClass) field.true_class = trueClass;
                    const falseClass = fieldEl.querySelector('.field-false-class')?.value.trim();
                    if (falseClass) field.false_class = falseClass;
                    const showIcon = fieldEl.querySelector('.field-show-icon')?.checked;
                    if (showIcon) field.show_icon = true;
                } else if (displayType === 'badge') {
                    const colorMap = fieldEl.querySelector('.field-badge-color-map')?.value.trim();
                    if (colorMap) {
                        try {
                            field.badge_color_map = JSON.parse(colorMap);
                        } catch (e) {
                            // Invalid JSON, skip
                        }
                    }
                } else if (displayType === 'html') {
                    const sanitize = fieldEl.querySelector('.field-sanitize')?.checked;
                    if (sanitize) field.sanitize = true;
                } else if (displayType === 'list') {
                    const displayAs = fieldEl.querySelector('.field-display-as')?.value;
                    if (displayAs) field.display_as = displayAs;
                    const separator = fieldEl.querySelector('.field-separator')?.value;
                    if (separator) field.separator = separator;
                    const hideIfEmpty = fieldEl.querySelector('.field-hide-if-empty')?.checked;
                    if (hideIfEmpty) field.hide_if_empty = true;
                } else if (displayType === 'file_link') {
                    const showSize = fieldEl.querySelector('.field-show-size')?.checked;
                    if (showSize) field.show_size = true;
                    const showIcon = fieldEl.querySelector('.field-show-icon')?.checked;
                    if (showIcon) field.show_icon = true;
                    const download = fieldEl.querySelector('.field-download')?.checked;
                    if (download) field.download = true;
                }

                displayFields.push(field);
            });
        });

        const jsonData = { display_fields: displayFields };
        document.getElementById('jsonPreview').textContent = JSON.stringify(jsonData, null, 2);
    },

    getFormData() {
        const displayFields = [];

        document.querySelectorAll('[data-section-index]').forEach(sectionEl => {
            const sectionIndex = sectionEl.dataset.sectionIndex;
            const sectionTitle = sectionEl.querySelector('.section-title').value.trim() || null;

            sectionEl.querySelectorAll('.field-card:not(.section-header)').forEach(fieldEl => {
                const fieldName = fieldEl.querySelector('.field-name').value.trim();
                if (!fieldName) return;

                const fieldLabel = fieldEl.querySelector('.field-label').value.trim();
                const displayType = fieldEl.querySelector('.field-display-type').value;
                const width = fieldEl.querySelector('.field-width').value.trim() || null;
                const inlineGroup = fieldEl.querySelector('.field-inline-group').value.trim() || null;
                const fullWidth = fieldEl.querySelector('.field-full-width').checked;
                const hideLabel = fieldEl.querySelector('.field-hide-label').checked;
                const styleClass = fieldEl.querySelector('.field-style-class').value || null;
                const order = displayFields.length + 1;

                const field = {
                    name: fieldName,
                    label: fieldLabel || fieldName,
                    display_type: displayType,
                    order: order,
                    ...(width && { width }),
                    ...(inlineGroup && { inline_group: inlineGroup }),
                    ...(fullWidth && { full_width: true }),
                    ...(hideLabel && { hide_label: true }),
                    ...(styleClass && { style_class: styleClass }),
                    ...(sectionTitle && { section: `section_${sectionIndex}`, section_title: sectionTitle })
                };

                // Add display type specific options
                if (displayType === 'date') {
                    const format = fieldEl.querySelector('.field-format')?.value.trim();
                    if (format) field.format = format;
                } else if (displayType === 'datetime') {
                    const format = fieldEl.querySelector('.field-format')?.value.trim();
                    if (format) field.format = format;
                    const relative = fieldEl.querySelector('.field-relative')?.checked;
                    if (relative) field.relative = true;
                } else if (displayType === 'stars') {
                    const maxStars = fieldEl.querySelector('.field-max-stars')?.value;
                    if (maxStars) field.max_stars = parseInt(maxStars);
                    const showNumber = fieldEl.querySelector('.field-show-number')?.checked;
                    if (showNumber) field.show_number = true;
                } else if (displayType === 'currency') {
                    const currencyCode = fieldEl.querySelector('.field-currency-code')?.value.trim();
                    if (currencyCode) field.currency_code = currencyCode;
                    const decimalPlaces = fieldEl.querySelector('.field-decimal-places')?.value;
                    if (decimalPlaces !== undefined) field.decimal_places = parseInt(decimalPlaces);
                    const separator = fieldEl.querySelector('.field-thousands-separator')?.checked;
                    if (separator) field.thousands_separator = true;
                } else if (displayType === 'boolean') {
                    const trueText = fieldEl.querySelector('.field-true-text')?.value.trim();
                    if (trueText) field.true_text = trueText;
                    const falseText = fieldEl.querySelector('.field-false-text')?.value.trim();
                    if (falseText) field.false_text = falseText;
                    const trueClass = fieldEl.querySelector('.field-true-class')?.value.trim();
                    if (trueClass) field.true_class = trueClass;
                    const falseClass = fieldEl.querySelector('.field-false-class')?.value.trim();
                    if (falseClass) field.false_class = falseClass;
                    const showIcon = fieldEl.querySelector('.field-show-icon')?.checked;
                    if (showIcon) field.show_icon = true;
                } else if (displayType === 'badge') {
                    const colorMap = fieldEl.querySelector('.field-badge-color-map')?.value.trim();
                    if (colorMap) {
                        try {
                            field.badge_color_map = JSON.parse(colorMap);
                        } catch (e) {
                            // Invalid JSON, skip
                        }
                    }
                } else if (displayType === 'html') {
                    const sanitize = fieldEl.querySelector('.field-sanitize')?.checked;
                    if (sanitize) field.sanitize = true;
                } else if (displayType === 'list') {
                    const displayAs = fieldEl.querySelector('.field-display-as')?.value;
                    if (displayAs) field.display_as = displayAs;
                    const separator = fieldEl.querySelector('.field-separator')?.value;
                    if (separator) field.separator = separator;
                    const hideIfEmpty = fieldEl.querySelector('.field-hide-if-empty')?.checked;
                    if (hideIfEmpty) field.hide_if_empty = true;
                } else if (displayType === 'file_link') {
                    const showSize = fieldEl.querySelector('.field-show-size')?.checked;
                    if (showSize) field.show_size = true;
                    const showIcon = fieldEl.querySelector('.field-show-icon')?.checked;
                    if (showIcon) field.show_icon = true;
                    const download = fieldEl.querySelector('.field-download')?.checked;
                    if (download) field.download = true;
                }

                displayFields.push(field);
            });
        });

        return {
            view: {
                display_fields: displayFields
            }
        };
    },

    async submit() {
        try {
            console.log('\n' + '='.repeat(60));
            console.log('[STEP4-SUBMIT] Step 4 ì œì¶œ ì‹œì‘');
            console.log('='.repeat(60));

            const formData = this.getFormData();

            console.log('[STEP4-SUBMIT-1] form_data ìˆ˜ì§‘ ì™„ë£Œ');
            console.log(`[STEP4-SUBMIT-2] ì´ ${formData.view.display_fields.length}ê°œ í•„ë“œ ì¤€ë¹„ë¨`);

            formData.view.display_fields.forEach((field, idx) => {
                console.log(`[STEP4-SUBMIT-3-${idx}] í•„ë“œ: ${field.name}`);
                console.log(`         - label: ${field.label}`);
                console.log(`         - display_type: ${field.display_type}`);
                console.log(`         - order: ${field.order}`);
                if (field.width) console.log(`         - width: ${field.width}`);
                if (field.inline_group) console.log(`         - inline_group: ${field.inline_group}`);
                if (field.full_width) console.log(`         - full_width: true`);
                if (field.style_class) console.log(`         - style_class: ${field.style_class}`);
                if (field.section_title) console.log(`         - section_title: ${field.section_title}`);
            });

            console.log('[STEP4-SUBMIT-4] JSON ì „ì†¡ ì¤€ë¹„:');
            console.log(JSON.stringify(formData, null, 2));

            console.log('[STEP4-SUBMIT-5] /boards/new/step4/{{ board.id }}ë¡œ POST ìš”ì²­ ì¤‘...');

            const response = await fetch('/boards/new/step4/{{ board.id }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            console.log(`[STEP4-SUBMIT-6] ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`);

            const data = await response.json();
            console.log('[STEP4-SUBMIT-7] ì‘ë‹µ ë°ì´í„°:', data);

            if (!response.ok) {
                console.log(`[STEP4-SUBMIT-ERROR] ì˜¤ë¥˜ ì‘ë‹µ: ${data.detail}`);
                alert('ì˜¤ë¥˜: ' + data.detail);
                return;
            }

            console.log('[STEP4-SUBMIT-8] âœ“ ì œì¶œ ì„±ê³µ');
            console.log(`[STEP4-SUBMIT-9] ë¦¬ë‹¤ì´ë ‰íŠ¸: ${data.redirect}`);
            console.log('='.repeat(60));
            window.location.href = data.redirect;
        } catch (error) {
            console.error('[STEP4-SUBMIT-ERROR] ì˜ˆì™¸ ë°œìƒ:', error);
            console.error('[STEP4-SUBMIT-ERROR] ë©”ì‹œì§€:', error.message);
            console.error('[STEP4-SUBMIT-ERROR] ìŠ¤íƒ:', error.stack);
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('\n[STEP4-DOM] DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
    viewStep4.init();
    console.log('[STEP4-DOM] âœ“ init() í˜¸ì¶œ ì™„ë£Œ\n');
});
</script>
{% endblock %}
